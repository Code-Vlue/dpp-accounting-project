# Next.js SSR on AWS Amplify - Core Fix

## Issue

AWS Amplify deployments were failing with the error:

```
!!! CustomerError: Can't find required-server-files.json in build output directory
```

This occurs because AWS Amplify's SSR deployment mode requires a special file called `required-server-files.json` in the `.next` directory, which isn't generated by default with the Next.js build process.

## Solution Overview

We've implemented a comprehensive fix that ensures all required files for AWS Amplify SSR deployment are properly generated:

1. Created a `post-build.js` script that generates the missing `required-server-files.json` file
2. Updated `amplify.yml` to run this script after the build process
3. Added a `server.js` file for SSR support
4. Configured `next.config.js` for proper standalone SSR output
5. Added an `amplify-ssr-fix.js` diagnostic tool for troubleshooting deployment issues

## Technical Implementation Details

### 1. The `post-build.js` Script

This script generates the `required-server-files.json` file required by AWS Amplify, which includes:
- References to the Next.js configuration
- List of server files needed for SSR
- Server trace information

### 2. Amplify.yml Configuration

The `amplify.yml` file has been updated to:
- Run the post-build script after the Next.js build
- Include `server.js` in the deployment artifacts
- Add a post-build phase to verify the required files exist

### 3. Server.js Implementation

A custom `server.js` file is now provided that:
- Creates an HTTP server for handling SSR requests
- Properly handles URL parsing and routing
- Includes error handling and graceful shutdown

### 4. Next.js Configuration

The `next.config.js` file is configured with:
- `output: 'standalone'` for proper SSR support
- A consistent build ID to help with caching
- Proper experimental settings for SSR

### 5. Diagnostic Tool

The `amplify-ssr-fix.js` script provides diagnostic capabilities to:
- Check for missing required files
- Create any missing files needed for deployment
- Validate the Next.js and Amplify configuration
- Provide detailed error messages and fix suggestions

## Deployment Verification

To verify the deployment:

1. Ensure Amplify app is configured with framework setting: "Next.js - SSR"
2. Run a build and check if the `required-server-files.json` file is generated
3. Verify that the Amplify deployment completes successfully
4. Test the deployed application to ensure SSR is working properly

## Troubleshooting

If deployment issues persist:

1. Run `npm run amplify-fix` locally to diagnose and fix common issues
2. Check the build logs for any specific errors related to missing files
3. Verify the Amplify app configuration is set to "Next.js - SSR" framework
4. Ensure all environment variables are properly set in the Amplify console

## References

- [AWS Amplify SSR Documentation](https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html)
- [Next.js Deployment Documentation](https://nextjs.org/docs/deployment)
- [Next.js Custom Server Documentation](https://nextjs.org/docs/advanced-features/custom-server)