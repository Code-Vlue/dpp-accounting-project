# Next.js SSR on AWS Amplify - Complete Solution

This document provides a comprehensive guide to solving AWS Amplify deployment issues with Next.js Server-Side Rendering (SSR) applications.

## Problem

AWS Amplify deployments for Next.js applications in SSR mode often fail with the error:

```
!!! CustomerError: Can't find required-server-files.json in build output directory
```

This occurs because AWS Amplify's SSR deployment process expects certain files that aren't generated by default during the Next.js build process.

## Complete Solution

### 1. Configure Next.js for SSR

First, ensure your `next.config.js` is properly configured for SSR:

```javascript
/** @type {import("next").NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  poweredByHeader: false,
  images: {
    domains: [],
  },
  // Output mode for deployment - CRITICAL for SSR
  output: 'standalone',
  // Ensure we generate all necessary files for SSR
  generateBuildId: async () => {
    return 'amplify-ssr-build';
  },
};

module.exports = nextConfig;
```

### 2. Create a Post-Build Script

Create a script at `scripts/post-build.js` to generate the required-server-files.json:

```javascript
const fs = require('fs');
const path = require('path');

// Define paths
const nextDir = path.resolve(process.cwd(), '.next');
const requiredServerFilesPath = path.join(nextDir, 'required-server-files.json');

// Generate the required-server-files.json file
function generateRequiredServerFiles() {
  console.log('Generating required-server-files.json for AWS Amplify SSR deployment...');
  
  // Create the content for required-server-files.json
  const requiredServerFiles = {
    config: {
      path: path.relative(nextDir, path.resolve(process.cwd(), 'next.config.js')),
      outputFileTracingRoot: process.cwd(),
      experimental: {
        missingSuspenseWithCSRBailout: false
      }
    },
    files: [
      path.relative(nextDir, path.resolve(nextDir, 'server')),
      path.relative(nextDir, path.resolve(nextDir, 'server/middleware-manifest.json')),
      path.relative(nextDir, path.resolve(nextDir, 'server/middleware-build-manifest.js')),
      path.relative(nextDir, path.resolve(nextDir, 'server/pages')),
      path.relative(nextDir, path.resolve(nextDir, 'server/app')),
      path.relative(nextDir, path.resolve(nextDir, 'server/chunks')),
      path.relative(nextDir, path.resolve(nextDir, 'server/webpack-runtime.js')),
      path.relative(nextDir, path.resolve(process.cwd(), 'package.json')),
      path.relative(nextDir, path.resolve(process.cwd(), 'next.config.js'))
    ]
  };

  // Write the file
  fs.writeFileSync(
    requiredServerFilesPath,
    JSON.stringify(requiredServerFiles, null, 2)
  );

  console.log(`Successfully created ${requiredServerFilesPath}`);
  return true;
}

// Execute the function
const success = generateRequiredServerFiles();
process.exit(success ? 0 : 1);
```

### 3. Create a Custom Server

Create a `server.js` file in your project root:

```javascript
const { createServer } = require('http');
const { parse } = require('url');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const port = process.env.PORT || 3000;
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
  createServer(async (req, res) => {
    try {
      const parsedUrl = parse(req.url, true);
      await handle(req, res, parsedUrl);
    } catch (err) {
      console.error('Error occurred handling', req.url, err);
      res.statusCode = 500;
      res.end('Internal Server Error');
    }
  }).listen(port, (err) => {
    if (err) throw err;
    console.log(`> Ready on http://localhost:${port}`);
  });
}).catch(err => {
  console.error('Error preparing server:', err);
  process.exit(1);
});
```

### 4. Update Package.json Scripts

Add these scripts to your `package.json`:

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "postbuild": "node ./scripts/post-build.js",
  "amplify-fix": "node ./scripts/amplify-ssr-fix.js",
  "start": "node server.js",
  ...
}
```

### 5. Configure amplify.yml

Update your `amplify.yml` file:

```yaml
version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - npm run build
            - node scripts/post-build.js
        postBuild:
          commands:
            - echo "Post-build phase completed - required-server-files.json generated"
      artifacts:
        baseDirectory: .
        files:
          - .next/**/*
          - node_modules/**/*
          - public/**/*
          - package.json
          - next.config.js
          - server.js
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
```

### 6. Set Amplify Framework Type

In the AWS Amplify Console, set the framework to "Next.js - SSR" (not SSG):

```bash
aws amplify update-branch --app-id YOUR_APP_ID --branch-name YOUR_BRANCH --framework "Next.js - SSR"
```

## Verification Steps

After implementing these changes:

1. Build your application locally:
   ```bash
   npm run build
   ```

2. Verify that `.next/required-server-files.json` was created.

3. Deploy to AWS Amplify through your preferred method (Git-based or manual).

4. Check deployment logs to ensure the build completes with no errors.

5. Test your deployed application to verify that SSR functionality works correctly.

## Troubleshooting

If you encounter issues:

1. Run the diagnostic tool:
   ```bash
   npm run amplify-fix
   ```

2. Check if all required files are being properly generated in the `.next` directory.

3. Verify the Amplify app is set to the "Next.js - SSR" framework (not SSG).

4. Ensure your `amplify.yml` includes all necessary files in the artifacts section.

5. Check that environment variables are properly configured in the Amplify Console.

## References

- [AWS Amplify Next.js SSR Documentation](https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html)
- [Next.js Deployment Documentation](https://nextjs.org/docs/deployment)
- [Next.js Output Configuration](https://nextjs.org/docs/api-reference/next.config.js/output)