version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        # Echo key debug info
        - echo "Environment $NODE_ENV"
        - node -v
        - npm -v
    build:
      commands:
        # Create standard .env.local file for build process
        - echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$NEXT_PUBLIC_COGNITO_USER_POOL_ID" >> .env.local
        - echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=$NEXT_PUBLIC_COGNITO_CLIENT_ID" >> .env.local
        - echo "NEXT_PUBLIC_COGNITO_REGION=$AWS_REGION" >> .env.local
        - echo "NEXT_PUBLIC_API_URL=https://master.d2ibw1me0nb2ns.amplifyapp.com/api" >> .env.local
        - echo "NEXT_PUBLIC_SITE_URL=https://master.d2ibw1me0nb2ns.amplifyapp.com" >> .env.local
        
        # Build the application
        - echo "Building server-side rendered application..."
        - npm run build
        
        # Generate required server files for SSR
        - node ./scripts/post-build.js
        
        # List built files
        - ls -la .next/
        
        # Make the start script executable
        - chmod +x amplify-start-command.sh
    postBuild:
      commands:
        - echo "Build completed on $(date)"
  artifacts:
    baseDirectory: .
    files:
      - package.json
      - package-lock.json
      - next.config.js
      - server.js
      - amplify-start-command.sh
      - .next/**/*
      - node_modules/**/*
      - public/**/*
      - required-server-files.json
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: Cache-Control
          value: 'public, max-age=0, must-revalidate'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*